# ğŸ“š ×××¡×˜×¨ ×™×™×‘×•× × ×ª×•× ×™× ×•×‘× ×™×™×ª ×× ×’× ×•×Ÿ ××‘ ××•×¦×¨

## ×ª××¨×™×š: 23 ×“×¦××‘×¨ 2025
## ××˜×¨×”: ×œ××™×“×ª ×™×™×‘×•× × ×ª×•× ×™× × ×›×•×Ÿ, ×× ×’× ×•×Ÿ ××‘ ××•×¦×¨, ×•×˜×™×¤×•×œ ×‘×›×¤×™×œ×•×™×•×ª

---

## ğŸ¯ ××” × ×œ××“ ×‘××¡××š ×–×”

1. **×™×™×‘×•× × ×ª×•× ×™× × ×›×•× ×™×** - ××™×š ×œ×§×œ×•×˜ × ×ª×•× ×™× ×××§×•×¨×•×ª ×©×•× ×™×
2. **×× ×’× ×•×Ÿ ××‘ ××•×¦×¨ (Master Product)** - ×”×¤×˜× ×˜ ×©×œ× ×•!
3. **×˜×™×¤×•×œ ×‘×›×¤×™×œ×•×™×•×ª** - ×× ×™×¢×ª duplicates
4. **×©××™×¨×ª × ×ª×•× ×™× ×¨×–×”** - ××•×¤×˜×™××™×–×¦×™×” ×•×™×¢×™×œ×•×ª
5. **×—×™×¤×•×© ×•×”×¦×œ×‘×” ××”×™×¨×™×** - Indexes + Cache
6. **×”×ª×—×‘×¨×•×ª ×œ××§×•×¨×•×ª ×—×“×©×™×** - ×”×¨×—×‘×ª ×”××¢×¨×›×ª

---

## ğŸ“¥ ×—×œ×§ 1: ×™×™×‘×•× × ×ª×•× ×™× × ×›×•× ×™×

### 1.1 ××¨×›×™×˜×§×˜×•×¨×ª ×”×™×™×‘×•×

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ××§×•×¨×•×ª × ×ª×•× ×™×                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. XML/GZ Files (Published Prices)   â† ×¨××™ ×œ×•×™, ×©×•×¤×¨×¡×œ     â”‚
â”‚ 2. API JSON (Real-time)               â† Laib, APIs         â”‚
â”‚ 3. HTML Scraping (Web)                â† ××ª×¨×™×              â”‚
â”‚ 4. Manual Upload (CSV/Excel)          â† ×™×“× ×™              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BaseSupermarketScraper                         â”‚
â”‚              (Framework ××©×•×ª×£)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Download files                                            â”‚
â”‚ âœ“ Decompress (GZ/ZIP/BZ2)                                  â”‚
â”‚ âœ“ Parse (XML/JSON/HTML)                                    â”‚
â”‚ âœ“ Normalize data                                           â”‚
â”‚ âœ“ Database import                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Database                                 â”‚
â”‚  products â†’ prices â†’ stores â†’ master_products              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ××‘× ×” ×”×§×•×“ - BaseSupermarketScraper

**×”×§×•×‘×¥:** `backend/scrapers/base_supermarket_scraper.py`

×–×”×• ×”-Framework ×”×‘×¡×™×¡×™ ×©×›×œ scraper ×™×•×¨×© ××× ×•:

```python
class BaseSupermarketScraper(ABC):
    """
    Framework ××©×•×ª×£ ×œ×›×œ ×”××§×•×¨×•×ª
    """
    
    # ×©×œ×‘ 1: ××ª×—×•×œ
    def __init__(self, chain_name, chain_slug, chain_id):
        self.chain_name = chain_name
        self.chain_id = chain_id
        self.conn = None  # Database connection
    
    # ×©×œ×‘ 2: ×”×ª×—×‘×¨×•×ª ×œ××§×•×¨ × ×ª×•× ×™×
    @abstractmethod
    def fetch_file_list(self) -> List[FileMetadata]:
        """
        ×›×œ scraper ××™×™×©× ××ª ×–×” ×‘×¦×•×¨×” ×©×œ×•
        - ×¨××™ ×œ×•×™: ×§×¨×™××” ×œHTML page
        - ×©×•×¤×¨×¡×œ: ×§×¨×™××” ×œ-API
        - Laib: ×§×¨×™××” ×œ-API ××—×¨
        """
        pass
    
    # ×©×œ×‘ 3: ×”×•×¨×“×ª ×§×‘×¦×™×
    def download_file(self, file_meta):
        """×¤×•× ×§×¦×™×” ××©×•×ª×¤×ª - ××•×¨×™×“×” ×§×•×‘×¥"""
        response = requests.get(file_meta.url)
        # ×©××™×¨×” ×œ×“×™×¡×§
    
    # ×©×œ×‘ 4: × ×™×ª×•×— ×§×‘×¦×™×
    @abstractmethod
    def parse_file(self, file_path) -> List[ParsedProduct]:
        """
        ×›×œ scraper ××™×™×©× parsing ××©×œ×•
        - XML: ×œ×¨××™ ×œ×•×™ ×•×©×•×¤×¨×¡×œ
        - JSON: ×œ-Laib
        - HTML: ×œ××ª×¨×™×
        """
        pass
    
    # ×©×œ×‘ 5: ×™×™×‘×•× ×œ-DB (××©×•×ª×£!)
    def import_product(self, product: ParsedProduct):
        """
        ×œ×•×’×™×§×” ××©×•×ª×¤×ª ×œ×›×•×œ×:
        1. ×—×™×¤×•×© ××•×¦×¨ ×§×™×™× (by barcode)
        2. ×™×¦×™×¨×ª ××•×¦×¨ ×—×“×© (×× ×œ× ×§×™×™×)
        3. ×”×›× ×¡×ª ××—×™×¨ (upsert_price)
        """
        # Get or Create Product
        product_id = self._get_or_create_product(product)
        
        # Upsert Price (×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª!)
        self._upsert_price(product_id, product.price)
```

### 1.3 ×“×•×’××”: PublishedPricesScraper

**×”×§×•×‘×¥:** `backend/scrapers/published_prices_scraper.py`

```python
class PublishedPricesScraper(BaseSupermarketScraper):
    """
    Scraper ×¢×‘×•×¨ ×¨××™ ×œ×•×™ (Published Prices platform)
    """
    
    def fetch_file_list(self):
        """
        1. ×”×ª×—×‘×¨×•×ª ×œ××ª×¨
        2. ×—×™×œ×•×¥ CSRF token
        3. ×§×¨×™××” ×œ×¨×©×™××ª ×§×‘×¦×™×
        """
        # Login
        session = requests.Session()
        csrf_token = self._extract_csrf_token()
        session.post(LOGIN_URL, data={
            'username': 'RamiLevi',
            'csrf_token': csrf_token
        })
        
        # Get file list
        response = session.get(FILE_LIST_API)
        files = response.json()
        
        return [FileMetadata(
            url=f['url'],
            filename=f['name'],
            file_type='prices'
        ) for f in files]
    
    def parse_file(self, file_path: Path):
        """
        Parse XML file
        """
        import xml.etree.ElementTree as ET
        
        tree = ET.parse(file_path)
        root = tree.getroot()
        
        products = []
        for item in root.findall('.//Item'):
            product = ParsedProduct(
                name=item.find('ItemName').text,
                barcode=item.find('ItemCode').text,
                price=float(item.find('ItemPrice').text),
                manufacturer=item.find('ManufacturerName').text
            )
            products.append(product)
        
        return {}, products
```

### 1.4 ×”×•×¡×¤×ª ××§×•×¨ ×—×“×© - 5 ×¦×¢×“×™× ×¤×©×•×˜×™×

```python
# ×§×•×‘×¥ ×—×“×©: backend/scrapers/new_source_scraper.py

from base_supermarket_scraper import BaseSupermarketScraper

class NewSourceScraper(BaseSupermarketScraper):
    """
    ×¦×¢×“ 1: ×”×’×“×¨×ª ×¤×¨×˜×™ ×”×¨×©×ª
    """
    def __init__(self):
        super().__init__(
            chain_name="New Chain",
            chain_slug="new-chain",
            chain_name_he="×¨×©×ª ×—×“×©×”",
            chain_id="7290999999999",
            country_code="IL"
        )
    
    """
    ×¦×¢×“ 2: ××™×š ×œ×”×©×™×’ ×¨×©×™××ª ×§×‘×¦×™×/××•×¦×¨×™×?
    """
    def fetch_file_list(self):
        # ××¤×©×¨×•×ª 1: API
        response = requests.get('https://api.newchain.com/files')
        return [FileMetadata(...) for f in response.json()]
        
        # ××¤×©×¨×•×ª 2: Scraping
        soup = BeautifulSoup(requests.get(URL).text, 'html.parser')
        return [FileMetadata(...) for link in soup.find_all('a')]
    
    """
    ×¦×¢×“ 3: ××™×š ×œ× ×ª×— ××ª ×”× ×ª×•× ×™×?
    """
    def parse_file(self, file_path):
        # ××¤×©×¨×•×ª 1: XML
        tree = ET.parse(file_path)
        
        # ××¤×©×¨×•×ª 2: JSON
        data = json.load(open(file_path))
        
        # ××¤×©×¨×•×ª 3: CSV
        df = pd.read_csv(file_path)
        
        # ×”××¨×” ×œ-ParsedProduct
        return metadata, products
    
    """
    ×¦×¢×“ 4: (××•×¤×¦×™×•× ×œ×™) ×× ×™×© store_id ×™×™×—×•×“×™
    """
    def build_store_identifier(self, store):
        # ×× ×™×© subchain
        return f"{self.chain_id}_{store.subchain}_{store.store_id}"
```

```bash
# ×¦×¢×“ 5: ×”×¨×¦×”!
python -c "
from backend.scrapers.new_source_scraper import NewSourceScraper
scraper = NewSourceScraper()
stats = scraper.import_files(limit=1)
print(stats)
"
```

---

## ğŸ‘‘ ×—×œ×§ 2: ×× ×’× ×•×Ÿ ××‘ ××•×¦×¨ (Master Product)

### 2.1 ×œ××” ×¦×¨×™×š ××‘ ××•×¦×¨?

**×”×‘×¢×™×”:**
```
××•×ª×• ××•×¦×¨ ×‘×©××•×ª ×©×•× ×™×:
- ğŸ‡®ğŸ‡± "×—×œ×‘ ×ª× ×•×‘×” 3% 1 ×œ×™×˜×¨"
- ğŸ‡ºğŸ‡¸ "Tnuva Milk 3% Fat 1L"
- ğŸ‡®ğŸ‡¹ "Latte Tnuva 3% 1L"

××™×š × ×“×¢ ×©×–×” ××•×ª×• ××•×¦×¨?! â† ×–×” ×”×¤×˜× ×˜!
```

**×”×¤×ª×¨×•×Ÿ: Master Product**
```
master_products:
  id: 999
  master_id: "tnuva-milk-3pct-1l"
  name: "Tnuva Milk 3% 1L"
  global_ean: "7290000000001"
  â†“ ×§×™×©×•×¨×™× ×œ×›×œ ×”××–×•×¨×™×:
  
product_master_links:
  â”œâ”€ Israel Product #54321 â†’ Master #999
  â”œâ”€ USA Product #78901 â†’ Master #999
  â””â”€ EU Product #11223 â†’ Master #999
```

### 2.2 3 ××¡×˜×¨×˜×’×™×•×ª ×§×™×©×•×¨

```python
class MasterProductMatcher:
    """
    ×× ×’× ×•×Ÿ ×—×›× ×œ×§×™×©×•×¨ ××•×¦×¨×™× ×œ××‘ ××•×¦×¨
    """
    
    def find_or_create_master(self, barcode, name, region):
        """
        3 ×©×œ×‘×™×, ×‘×¡×“×¨ ×¢×“×™×¤×•×ª:
        """
        
        # â”€â”€ ××¡×˜×¨×˜×’×™×” 1: Barcode Match (70% ××”××§×¨×™×) â”€â”€
        # ××”×™×¨ ×•××“×•×™×§!
        master = self._search_by_barcode(barcode)
        if master:
            return master  # âœ… × ××¦×!
        
        # â”€â”€ ××¡×˜×¨×˜×’×™×” 2: AI Similarity (25% ××”××§×¨×™×) â”€â”€
        # ×—×™×¤×•×© ×¡×× ×˜×™ ×¢× embeddings
        master = self._search_by_embedding(name)
        if master and master['confidence'] > 0.90:
            return master  # âœ… × ××¦×!
        
        # â”€â”€ ××¡×˜×¨×˜×’×™×” 3: Create New (5% ××”××§×¨×™×) â”€â”€
        # ×™×¦×™×¨×ª ××‘ ××•×¦×¨ ×—×“×© ×¢× GPT-4
        return self._create_master_with_llm(name, barcode)
    
    def _search_by_barcode(self, barcode):
        """
        ××¡×˜×¨×˜×’×™×” 1: ×—×™×¤×•×© ×œ×¤×™ ×‘×¨×§×•×“
        - ×”×›×™ ××”×™×¨ (10ms)
        - ×”×›×™ ××“×•×™×§ (100%)
        """
        return db.query("""
            SELECT id, master_id, name
            FROM master_products
            WHERE global_ean = %s
        """, barcode)
    
    def _search_by_embedding(self, name):
        """
        ××¡×˜×¨×˜×’×™×” 2: ×—×™×¤×•×© ×¡×× ×˜×™
        - ×™×•×ª×¨ ××™×˜×™ (250ms)
        - ×“×™×•×§ ×’×‘×•×” (90%+)
        """
        # ×™×¦×™×¨×ª embedding
        embedding = openai.Embedding.create(
            input=name,
            model="text-embedding-ada-002"
        )
        
        # ×—×™×¤×•×© ×“×•××™× (pgvector)
        return db.query("""
            SELECT id, master_id, name,
                   1 - (embedding <=> %s::vector) as similarity
            FROM master_products
            WHERE 1 - (embedding <=> %s::vector) > 0.90
            ORDER BY similarity DESC
            LIMIT 1
        """, embedding)
    
    def _create_master_with_llm(self, name, barcode):
        """
        ××¡×˜×¨×˜×’×™×” 3: ×™×¦×™×¨×ª ××‘ ××•×¦×¨ ×—×“×©
        - ×”×›×™ ××™×˜×™ (1.2 ×©× ×™×•×ª)
        - × ×“×¨×© ×¨×§ ×œ-5% ××”××•×¦×¨×™× ×”×—×“×©×™×
        """
        # ×©×œ×‘ 1: ×—×™×œ×•×¥ attributes ×¢× GPT-4
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=[{
                "role": "user",
                "content": f"""
Extract product attributes from: {name}
Return JSON:
{{
  "brand": "Tnuva",
  "product_type": "Milk",
  "attributes": {{"fat": "3%", "volume": "1L"}},
  "category": "Food > Dairy > Milk"
}}
"""
            }],
            response_format={"type": "json_object"}
        )
        
        attrs = json.loads(response.choices[0].message.content)
        
        # ×©×œ×‘ 2: ×™×¦×™×¨×ª master_id
        master_id = self._generate_id(attrs)
        # â†’ "tnuva-milk-3pct-1l"
        
        # ×©×œ×‘ 3: ×©××™×¨×” ×‘-DB
        return db.execute("""
            INSERT INTO master_products (
                master_id, name, global_ean, 
                brand, category, attributes, embedding
            ) VALUES (%s, %s, %s, %s, %s, %s, %s)
            RETURNING id
        """, ...)
```

### 2.3 Database Schema - Master Products

```sql
-- ×˜×‘×œ×”: master_products
-- ××‘ ××•×¦×¨ ×’×œ×•×‘×œ×™
CREATE TABLE master_products (
    id BIGSERIAL PRIMARY KEY,
    master_id VARCHAR(200) UNIQUE,        -- "tnuva-milk-3pct-1l"
    name VARCHAR(500),
    global_ean VARCHAR(20),                -- ×‘×¨×§×•×“ ×’×œ×•×‘×œ×™
    
    -- Classification
    brand VARCHAR(200),
    category VARCHAR(500),                 -- "Food > Dairy > Milk"
    attributes JSONB,                      -- {"fat": "3%", "volume": "1L"}
    
    -- AI
    embedding vector(1536),                -- pgvector
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- Indexes ×§×¨×™×˜×™×™×
CREATE INDEX idx_master_ean ON master_products(global_ean);
CREATE INDEX idx_master_embedding ON master_products 
    USING ivfflat (embedding vector_cosine_ops);

-- ×˜×‘×œ×”: product_master_links
-- ×§×™×©×•×¨ ×‘×™×Ÿ ××•×¦×¨ ××–×•×¨×™ ×œ××‘ ××•×¦×¨
CREATE TABLE product_master_links (
    id BIGSERIAL PRIMARY KEY,
    master_product_id BIGINT REFERENCES master_products(id),
    regional_product_id BIGINT REFERENCES products(id),
    region VARCHAR(10),                    -- "IL", "US", "EU"
    
    -- Quality metrics
    confidence_score DECIMAL(3,2),         -- 0.95 = 95%
    match_method VARCHAR(50),              -- "barcode", "embedding", "llm"
    
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(regional_product_id)            -- ×›×œ ××•×¦×¨ ××§×•×©×¨ ×¨×§ ×œ××‘ ××—×“
);

-- ×˜×‘×œ×”: prices
-- ×”×•×¡×¤×ª master_product_id ×œ××—×™×¨×™×!
ALTER TABLE prices ADD COLUMN master_product_id BIGINT 
    REFERENCES master_products(id);
CREATE INDEX idx_prices_master ON prices(master_product_id);
```

---

## ğŸš« ×—×œ×§ 3: ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª

### 3.1 ×‘×¢×™×™×ª ×”×›×¤×™×œ×•×™×•×ª

```
WITHOUT duplicate prevention:
âŒ Product "×—×œ×‘ ×ª× ×•×‘×”" created 50 times
âŒ Price $5.90 stored 100 times for same product
âŒ Database full of junk!

WITH duplicate prevention:
âœ… Product "×—×œ×‘ ×ª× ×•×‘×”" created once
âœ… Price $5.90 updated (not duplicated)
âœ… Clean, lean database!
```

### 3.2 ×¤×ª×¨×•×Ÿ 1: upsert_price Function

```sql
-- Function: upsert_price
-- ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª ×‘××—×™×¨×™×
CREATE OR REPLACE FUNCTION upsert_price(
    p_product_id BIGINT,
    p_supplier_id INTEGER,
    p_store_id BIGINT,
    p_price DECIMAL,
    p_currency VARCHAR,
    p_is_available BOOLEAN,
    p_tolerance DECIMAL DEFAULT 0.01
) RETURNS VOID AS $$
DECLARE
    v_existing_price DECIMAL;
    v_price_id BIGINT;
BEGIN
    -- ×—×™×¤×•×© ××—×™×¨ ×§×™×™×
    SELECT id, price INTO v_price_id, v_existing_price
    FROM prices
    WHERE product_id = p_product_id
      AND supplier_id = p_supplier_id
      AND store_id = p_store_id
      AND is_available = TRUE
    ORDER BY scraped_at DESC
    LIMIT 1;
    
    IF FOUND THEN
        -- ××—×™×¨ ×§×™×™×!
        
        -- ×‘×“×™×§×”: ×”×× ×”××—×™×¨ ×”×©×ª× ×”?
        IF ABS(v_existing_price - p_price) <= p_tolerance THEN
            -- ××—×™×¨ ×–×”×” (Â±1%) â†’ ×¨×§ ×¢×“×›×•×Ÿ timestamp
            UPDATE prices
            SET last_scraped_at = NOW()
            WHERE id = v_price_id;
            
            RAISE NOTICE 'Price unchanged: %', v_price_id;
        ELSE
            -- ××—×™×¨ ×”×©×ª× ×” â†’ ×¨×©×•××” ×—×“×©×”
            INSERT INTO prices (
                product_id, supplier_id, store_id,
                price, currency, is_available,
                scraped_at, first_scraped_at, last_scraped_at
            ) VALUES (
                p_product_id, p_supplier_id, p_store_id,
                p_price, p_currency, p_is_available,
                NOW(), NOW(), NOW()
            );
            
            RAISE NOTICE 'Price changed: % -> %', v_existing_price, p_price;
        END IF;
    ELSE
        -- ××—×™×¨ ×—×“×© ×œ×’××¨×™
        INSERT INTO prices (
            product_id, supplier_id, store_id,
            price, currency, is_available,
            scraped_at, first_scraped_at, last_scraped_at
        ) VALUES (
            p_product_id, p_supplier_id, p_store_id,
            p_price, p_currency, p_is_available,
            NOW(), NOW(), NOW()
        );
        
        RAISE NOTICE 'New price created';
    END IF;
END;
$$ LANGUAGE plpgsql;
```

**×©×™××•×©:**
```python
# ×‘××§×•× INSERT ×¨×’×™×œ:
cursor.execute("""
    SELECT upsert_price(
        %s,    -- product_id
        %s,    -- supplier_id
        %s,    -- store_id
        %s,    -- price
        'ILS',
        TRUE,  -- is_available
        0.01   -- tolerance (1%)
    )
""", (product_id, supplier_id, store_id, price))
```

### 3.3 ×¤×ª×¨×•×Ÿ 2: ON CONFLICT

```sql
-- ×× ×™×¢×ª ×›×¤×™×œ×•×ª ×‘××•×¦×¨×™×
INSERT INTO products (name, ean, manufacturer_code)
VALUES ('×—×œ×‘ ×ª× ×•×‘×”', '7290000000001', '7290000000001')
ON CONFLICT (ean)           -- ×× ×‘×¨×§×•×“ ×§×™×™×
DO UPDATE SET               -- ×¢×“×›×Ÿ ×‘××§×•× ×œ×™×¦×•×¨ ×›×¤×™×œ×•×ª
    name = EXCLUDED.name
RETURNING id;

-- ×× ×™×¢×ª ×›×¤×™×œ×•×ª ×‘×¡× ×™×¤×™×
INSERT INTO stores (chain_id, store_id, name, city)
VALUES (153, '001', '×¨××™ ×œ×•×™ ×©×™×§××”', '×ª×œ ××‘×™×‘')
ON CONFLICT (chain_id, store_id)  -- store ×™×™×—×•×“×™ ×œ×¤×™ chain+store_id
DO UPDATE SET
    name = EXCLUDED.name,
    city = EXCLUDED.city
RETURNING id;
```

### 3.4 ×¤×ª×¨×•×Ÿ 3: Redis Cache (99% hit rate!)

```python
class ProductCache:
    """Cache ×œ×× ×™×¢×ª queries ××™×•×ª×¨×™× ×œ-DB"""
    
    def get_or_create_product(self, barcode, name):
        # â”€â”€ ×©×œ×‘ 1: ×‘×“×™×§×” ×‘-Cache (99% hit!) â”€â”€
        cache_key = f"product:ean:{barcode}"
        cached_id = redis.get(cache_key)
        
        if cached_id:
            return int(cached_id)  # âœ… Cache HIT (0.5ms)
        
        # â”€â”€ ×©×œ×‘ 2: ×‘×“×™×§×” ×‘-DB (1% miss) â”€â”€
        product_id = db.query("""
            SELECT id FROM products
            WHERE ean = %s
            LIMIT 1
        """, barcode)
        
        if product_id:
            # ×©××™×¨×” ×‘-Cache ×œ×¤×¢× ×”×‘××”
            redis.setex(cache_key, 86400, product_id)  # 24h
            return product_id
        
        # â”€â”€ ×©×œ×‘ 3: ×™×¦×™×¨×” (0.1% new) â”€â”€
        product_id = db.execute("""
            INSERT INTO products (name, ean)
            VALUES (%s, %s)
            ON CONFLICT (ean) DO UPDATE SET name = EXCLUDED.name
            RETURNING id
        """, name, barcode)
        
        # ×©××™×¨×” ×‘-Cache
        redis.setex(cache_key, 86400, product_id)
        return product_id
```

**×ª×•×¦××”:**
```
×™×™×‘×•× 100,000 ××•×¦×¨×™×:
- ×œ×œ× Cache: 100,000 DB queries = 1000 ×©× ×™×•×ª âŒ
- ×¢× Cache:  1,000 DB queries = 10 ×©× ×™×•×ª âœ…
```

---

## ğŸ’¾ ×—×œ×§ 4: ×©××™×¨×ª × ×ª×•× ×™× ×¨×–×” ×•×™×¢×™×œ×”

### 4.1 ×¢×§×¨×•× ×•×ª Lean Data

```
1. âœ… NO DUPLICATES
   - upsert_price ×‘××§×•× INSERT
   - ON CONFLICT DO UPDATE
   - Redis Cache

2. âœ… NORMALIZE
   - ××‘ ××•×¦×¨ ××—×“ â†’ N ××•×¦×¨×™× ××–×•×¨×™×™×
   - product_id ×‘××§×•× ×©××™×¨×ª ×©× ××œ× ×‘×›×œ ××—×™×¨

3. âœ… COMPRESS
   - JSONB ×œ×ª×›×•× ×•×ª ××©×ª× ×•×ª
   - Index ×¨×§ ××” ×©×¦×¨×™×š
   - Partition ×œ×¤×™ ×ª××¨×™×š

4. âœ… ARCHIVE OLD DATA
   - ××—×™×¨×™× ×™×©× ×™× â†’ TimescaleDB
   - Retention policy (2 ×©× ×™×)
```

### 4.2 JSONB - ×©××™×¨×ª Attributes

```sql
-- ×‘××§×•× ×¢××•×“×•×ª × ×¤×¨×“×•×ª ×œ×›×œ ×ª×›×•× ×”:
ALTER TABLE products ADD COLUMN color VARCHAR(50);
ALTER TABLE products ADD COLUMN size VARCHAR(50);
ALTER TABLE products ADD COLUMN material VARCHAR(50);
-- ... 100+ columns?! âŒ

-- ×¤×ª×¨×•×Ÿ: JSONB
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(500),
    ean VARCHAR(20),
    attributes JSONB DEFAULT '{}'::jsonb  -- âœ…
);

-- ×“×•×’××”:
INSERT INTO products (name, ean, attributes) VALUES (
    '×—×•×œ×¦×ª ×¤×•×œ×•',
    '1234567890',
    '{"color": "×›×—×•×œ", "size": "L", "material": "×›×•×ª× ×”"}'::jsonb
);

-- Query:
SELECT * FROM products
WHERE attributes->>'color' = '×›×—×•×œ'
  AND attributes->>'size' = 'L';

-- Index ×¢×œ JSONB
CREATE INDEX idx_products_attributes ON products 
    USING gin(attributes);
```

### 4.3 Partitioning - ×—×œ×•×§×ª ×˜×‘×œ××•×ª ×’×“×•×œ×•×ª

```sql
-- prices table ×™×›×•×œ×” ×œ×”×™×•×ª ×¢× ×§×™×ª (××™×œ×™××¨×“×™ ×©×•×¨×•×ª!)
-- ×¤×ª×¨×•×Ÿ: Partition ×œ×¤×™ ×ª××¨×™×š

CREATE TABLE prices (
    id BIGSERIAL,
    product_id BIGINT,
    price DECIMAL,
    scraped_at TIMESTAMP,
    ...
) PARTITION BY RANGE (scraped_at);

-- ×™×¦×™×¨×ª partitions
CREATE TABLE prices_2025_12 PARTITION OF prices
    FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');

CREATE TABLE prices_2026_01 PARTITION OF prices
    FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');

-- ×™×ª×¨×•× ×•×ª:
-- âœ… Query ××”×™×¨ (×¨×§ partition ×¨×œ×•×•× ×˜×™)
-- âœ… Backup ×§×œ (partition ×‘× ×¤×¨×“)
-- âœ… ××—×™×§×” ××”×™×¨×” (DROP partition ×™×©×Ÿ)
```

---

## ğŸ” ×—×œ×§ 5: ×—×™×¤×•×© ××”×™×¨ ×•×”×¦×œ×‘×”

### 5.1 Indexes ×§×¨×™×˜×™×™×

```sql
-- â•â•â•â•â•â•â•â•â•â•â• Products Table â•â•â•â•â•â•â•â•â•â•â•
CREATE INDEX idx_products_ean ON products(ean) 
    WHERE ean IS NOT NULL;                        -- ×—×™×¤×•×© ×œ×¤×™ ×‘×¨×§×•×“

CREATE INDEX idx_products_name_trgm ON products 
    USING gin(name gin_trgm_ops);                 -- ×—×™×¤×•×© fuzzy

CREATE INDEX idx_products_search ON products 
    USING gin(to_tsvector('english', name));      -- Full-text search

-- â•â•â•â•â•â•â•â•â•â•â• Prices Table â•â•â•â•â•â•â•â•â•â•â•
CREATE INDEX idx_prices_product_time ON prices(
    product_id, scraped_at DESC
);                                                -- ××—×™×¨×™× ××—×¨×•× ×™× ×œ××•×¦×¨

CREATE INDEX idx_prices_master ON prices(
    master_product_id, scraped_at DESC
);                                                -- ×”×©×•×•××” ×’×œ×•×‘×œ×™×ª!

CREATE INDEX idx_prices_store ON prices(
    store_id, is_available
) WHERE is_available = TRUE;                      -- ××•×¦×¨×™× ×–××™× ×™× ×‘×¡× ×™×£

-- â•â•â•â•â•â•â•â•â•â•â• Stores Table â•â•â•â•â•â•â•â•â•â•â•
CREATE INDEX idx_stores_location ON stores 
    USING gist(geom);                             -- ×—×™×¤×•×© ×’×™××•×’×¨×¤×™

CREATE INDEX idx_stores_city ON stores(city);    -- ×—×™×¤×•×© ×œ×¤×™ ×¢×™×¨
```

### 5.2 ×“×•×’×××•×ª Query ××”×™×¨×•×ª

```sql
-- ×“×•×’××” 1: ××¦× ××ª ×”××—×™×¨ ×”×–×•×œ ×‘×™×•×ª×¨ ×œ××•×¦×¨
SELECT 
    s.name as store_name,
    s.city,
    p.price,
    p.scraped_at
FROM prices p
JOIN stores s ON p.store_id = s.id
WHERE p.product_id = 54321
  AND p.is_available = TRUE
ORDER BY p.price ASC
LIMIT 5;
-- âš¡ 2ms (×‘×–×›×•×ª idx_prices_product_time)

-- ×“×•×’××” 2: ×”×©×•×•××” ×’×œ×•×‘×œ×™×ª ×œ××‘ ××•×¦×¨
SELECT 
    pml.region,
    p.name as product_name,
    AVG(pr.price) as avg_price,
    COUNT(*) as price_count
FROM product_master_links pml
JOIN products p ON pml.regional_product_id = p.id
JOIN prices pr ON pr.product_id = p.id
WHERE pml.master_product_id = 999  -- "tnuva-milk-3pct-1l"
  AND pr.is_available = TRUE
  AND pr.scraped_at > NOW() - INTERVAL '7 days'
GROUP BY pml.region, p.name;
-- âš¡ 10ms (×‘×–×›×•×ª idx_prices_master)

-- ×“×•×’××” 3: ××•×¦×¨×™× ×–××™× ×™× ×‘×˜×•×•×— 5 ×§"×
SELECT 
    p.name,
    s.name as store_name,
    pr.price,
    ST_Distance(s.geom, ST_MakePoint(34.7818, 32.0853)::geography) / 1000 as distance_km
FROM products p
JOIN prices pr ON pr.product_id = p.id
JOIN stores s ON pr.store_id = s.id
WHERE ST_DWithin(
    s.geom,
    ST_MakePoint(34.7818, 32.0853)::geography,
    5000  -- 5km
)
AND pr.is_available = TRUE
ORDER BY distance_km;
-- âš¡ 15ms (×‘×–×›×•×ª idx_stores_location)
```

### 5.3 Materialized Views - ×ª×•×¦××•×ª ××•×›× ×•×ª ××¨××©

```sql
-- ×‘××§×•× ×œ×—×©×‘ ×›×œ ×¤×¢×, × ×›×™×Ÿ ××¨××©!
CREATE MATERIALIZED VIEW mv_product_best_prices AS
SELECT 
    p.id as product_id,
    p.name,
    MIN(pr.price) as min_price,
    MAX(pr.price) as max_price,
    AVG(pr.price) as avg_price,
    COUNT(DISTINCT pr.store_id) as store_count
FROM products p
JOIN prices pr ON pr.product_id = p.id
WHERE pr.is_available = TRUE
  AND pr.scraped_at > NOW() - INTERVAL '7 days'
GROUP BY p.id, p.name;

CREATE UNIQUE INDEX ON mv_product_best_prices(product_id);

-- ×¨×¢× ×•×Ÿ ×™×•××™
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_product_best_prices;

-- ×©×™××•×©:
SELECT * FROM mv_product_best_prices WHERE product_id = 54321;
-- âš¡ 0.1ms! (×‘××§×•× 50ms)
```

---

## ğŸ”Œ ×—×œ×§ 6: ×”×ª×—×‘×¨×•×ª ××”×™×¨×” ×œ××§×•×¨×•×ª ×—×“×©×™×

### 6.1 Checklist - ×”×•×¡×¤×ª ××§×•×¨ ×—×“×©

```markdown
[ ] 1. ×¦×•×¨ scraper class ×—×“×©
    - ×™×¨×© ×-BaseSupermarketScraper
    - ×§×•×‘×¥: backend/scrapers/[name]_scraper.py

[ ] 2. ×™×™×©× fetch_file_list()
    - API? Web scraping? FTP?
    - ×”×—×–×¨ List[FileMetadata]

[ ] 3. ×™×™×©× parse_file()
    - XML? JSON? CSV?
    - ×”××¨ ×œ-List[ParsedProduct]

[ ] 4. (××•×¤×¦×™×•× ×œ×™) build_store_identifier()
    - ×× ×™×© subchain/××–×”×” ×™×™×—×•×“×™

[ ] 5. ×‘×“×™×§×”
    - ×”×¨×¥ import_files(limit=1)
    - ×‘×“×•×§ DB

[ ] 6. ××•×˜×•××¦×™×”
    - ×¦×•×¨ BAT script
    - ×”×•×¡×£ ×œ-scheduler
```

### 6.2 ×ª×‘× ×™×ª ××•×›× ×”

```python
# backend/scrapers/template_scraper.py
from base_supermarket_scraper import BaseSupermarketScraper, FileMetadata, ParsedProduct
import requests
from pathlib import Path

class TemplateScraper(BaseSupermarketScraper):
    """
    Template for new data sources
    Copy this file and modify!
    """
    
    def __init__(self):
        super().__init__(
            chain_name="Chain Name",           # â† ×©× ×”
            chain_slug="chain-name",           # â† ×©× ×”
            chain_name_he="×©× ×”×¨×©×ª",          # â† ×©× ×”
            chain_id="7290XXXXXXXXX",          # â† ×©× ×”
            country_code="IL"                  # â† ×©× ×”
        )
        self.api_url = "https://..."         # â† ×©× ×”
        self.api_key = "..."                  # â† ×©× ×”
    
    def fetch_file_list(self, file_type='prices', limit=None):
        """××™×š ×œ×”×©×™×’ ×¨×©×™××ª ×§×‘×¦×™×?"""
        
        # Option A: API Call
        response = requests.get(
            f"{self.api_url}/files",
            headers={"Authorization": f"Bearer {self.api_key}"}
        )
        data = response.json()
        
        files = []
        for item in data[:limit]:
            files.append(FileMetadata(
                url=item['download_url'],      # â† ×©× ×”
                filename=item['filename'],     # â† ×©× ×”
                file_type='prices'
            ))
        
        return files
    
    def parse_file(self, file_path: Path):
        """××™×š ×œ× ×ª×— ××ª ×”×§×•×‘×¥?"""
        
        products = []
        
        # Option A: JSON
        import json
        data = json.load(open(file_path))
        
        for item in data['products']:
            product = ParsedProduct(
                name=item['name'],             # â† ×©× ×”
                barcode=item['barcode'],       # â† ×©× ×”
                price=float(item['price']),    # â† ×©× ×”
                manufacturer=item.get('brand')
            )
            products.append(product)
        
        metadata = {
            'store_id': data.get('store_id'),
            'timestamp': data.get('timestamp')
        }
        
        return metadata, products

# Usage:
if __name__ == "__main__":
    scraper = TemplateScraper()
    stats = scraper.import_files(limit=5)
    print(f"âœ… Imported: {stats}")
```

---

## ğŸ“– ×—×œ×§ 7: ××¡×œ×•×œ ×œ××™×“×” ××•××œ×¥

### ×©×‘×•×¢ 1: ×”×‘× ×”
```
×™×•× 1-2:
â–¡ ×§×¨× ××¡××š ×–×” ××œ× (30 ×“×§×•×ª)
â–¡ ×”×‘×˜ ×‘-base_supermarket_scraper.py (20 ×“×§×•×ª)
â–¡ ×”×‘×˜ ×‘-schema.sql (15 ×“×§×•×ª)

×™×•× 3-4:
â–¡ ×”×¨×¥ scraper ×§×™×™× (published_prices_scraper.py)
â–¡ ×¢×§×•×‘ ××—×¨×™ ×”× ×ª×•× ×™× ×‘-DB
â–¡ ×”×‘×Ÿ ××ª ×”-flow ×”××œ×

×™×•× 5:
â–¡ × ×¡×” ×œ×™×¦×•×¨ scraper ×¤×©×•×˜ ××©×œ×š
â–¡ ×”×©×ª××© ×‘-template
```

### ×©×‘×•×¢ 2: ×ª×¨×’×•×œ
```
â–¡ ×‘× ×” scraper ×œ××§×•×¨ ×—×“×©
â–¡ ×™×™×©× master product matching
â–¡ ×”×•×¡×£ indexes
â–¡ ×‘×“×•×§ ×‘×™×¦×•×¢×™×
```

### ×©×‘×•×¢ 3: ××•×¤×˜×™××™×–×¦×™×”
```
â–¡ ×”×•×¡×£ Redis cache
â–¡ ×™×™×©× batch processing
â–¡ ×¦×•×¨ materialized views
â–¡ ××“×•×“ ×‘×™×¦×•×¢×™×
```

---

## âœ… ×¡×™×›×•× - ×”× ×§×•×“×•×ª ×”×—×©×•×‘×•×ª

### ×™×™×‘×•× × ×ª×•× ×™×:
1. **Framework ××—×™×“** - BaseSupermarketScraper ×œ×›×œ ×”××§×•×¨×•×ª
2. **3 ×©×œ×‘×™×** - Download â†’ Parse â†’ Import
3. **×”×¨×—×‘×” ×§×œ×”** - 5 ×¦×¢×“×™× ×œ×”×•×¡×¤×ª ××§×•×¨ ×—×“×©

### ××‘ ××•×¦×¨:
1. **3 ××¡×˜×¨×˜×’×™×•×ª** - Barcode (70%) â†’ AI (25%) â†’ Create (5%)
2. **×§×™×©×•×¨ ×—×›×** - product_master_links
3. **×”×©×•×•××” ×’×œ×•×‘×œ×™×ª** - master_product_id ×‘×›×œ ××—×™×¨

### ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª:
1. **upsert_price** - ×¢×“×›×•×Ÿ ×‘××§×•× duplicate
2. **ON CONFLICT** - Postgres built-in
3. **Redis Cache** - 99% hit rate

### ×©××™×¨×” ×¨×–×”:
1. **JSONB** - attributes ××©×ª× ×™×
2. **Normalization** - ××‘ ×§××•×¦×¨ â†’ N ××•×¦×¨×™×
3. **Partitioning** - prices ×œ×¤×™ ×ª××¨×™×š

### ×—×™×¤×•×© ××”×™×¨:
1. **Indexes × ×›×•× ×™×** - ×¢×œ EAN, product_id, master_product_id
2. **Materialized Views** - ×ª×•×¦××•×ª ××•×›× ×•×ª
3. **GIN/GiST** - Full-text + Geo search

---

## ğŸ¯ ×”×¦×¢×“×™× ×”×‘××™× ×©×œ×š

```bash
# 1. × ×¡×” scraper ×§×™×™×
cd "c:/Users/shake/Limor Shaked Dropbox/LIMOR SHAKED ADVANCED COSMETICS LTD/Gogobe"
python backend/scrapers/published_prices_scraper.py

# 2. ×‘×“×•×§ ××ª ×”-DB
psql -U postgres -d gogobe
SELECT COUNT(*) FROM products;
SELECT COUNT(*) FROM prices;

# 3. ×¦×•×¨ scraper ×—×“×© ××©×œ×š
cp backend/scrapers/template_scraper.py backend/scrapers/my_scraper.py
# ×¢×¨×•×š ××ª my_scraper.py

# 4. ×”×¨×¥!
python backend/scrapers/my_scraper.py
```

---

**ğŸš€ ×‘×”×¦×œ×—×”! ×™×© ×œ×š ×¢×›×©×™×• ××ª ×›×œ ×”×™×“×¢ ×”×“×¨×•×©!**

×ª××¨×™×š: 23 ×“×¦××‘×¨ 2025
×’×¨×¡×”: 1.0
