# מדריך בניית בסיס הנתונים מחדש (Database Rebuild) 🏗️

מדריך זה מסביר כיצד להקים את בסיס הנתונים מאפס, כולל מבנה הטבלאות, ה-Partitioning, והלוגיקות המיוחדות.

## 1. שחזור הסכמה (Schema) 📐
בקובץ `backend/db/full_schema.sql` נמצא הגיבוי המלא של מבנה הנתונים (ללא המידע עצמו).
קובץ זה כולל:
- הגדרת טבלאות (Products, Stores, Chains).
- הגדרת טבלת המחירים (`prices`) כטבלה מפוצלת (Partitioned Table).
- אינדקסים, Views, ופונקציות עזר.

**פקודה לשחזור (בכניסה ראשונית):**
```bash
docker-compose exec -T db psql -U postgres -d gogobe < backend/db/full_schema.sql
```

## 2. ניהול חלוקה לחודשים (Partitioning) 📅
טבלת המחירים (`prices`) בנויה בשיטת **Range Partitioning**.
כל חודש מקבל טבלה משלו (למשל `prices_2025_01`), מה שמאפשר למערכת לרוץ מהר גם עם מיליוני שורות.

### איך זה עובד?
1.  **הטבלה הראשית (`prices`)**: היא רק "נתב" (Router). היא לא מחזיקה מידע בעצמה.
2.  **תתי-טבלאות (Partitions)**: מחזיקות את המידע בפועל לפי חודש ה-`scraped_at`.

### יצירת חודשים עתידיים אוטומטית 🤖
ביצענו אוטומציה לנושא הזה. הסקריפט `backend/scripts/maintain_partitions.py`:
1.  בודק מה התאריך היום.
2.  בודק אם קיימות טבלאות לחודש הנוכחי ולחודשיים הבאים.
3.  אם חסר חודש – הוא יוצר אותו אוטומטית (מריץ `CREATE TABLE ... PARTITION OF`).

**איך מפעילים?**
הסקריפט הזה מתוכנן לרוץ אוטומטית (דרך ה-Scheduler), אבל ניתן להריץ אותו ידנית בכל רגע כדי לוודא שהכל מוכן:
```bash
docker-compose exec api python /app/backend/scripts/maintain_partitions.py
```
*מומלץ להריץ אותו פעם אחת בהתקנה חדשה כדי לוודא שהחודש הנוכחי נוצר.*

## 3. ניקוי ותחזוקה (Maintenance) 🧹
כדי שהדאטה-בייס לא "יתנפח", בנינו תוכנית עתידית (`maintain_db.py`) שתרוץ פעם בשבוע ותבצע:
- **VACUUM ANALYZE**: דחיסת רשומות מחוקות ושיפור סטטיסטיקות לשליפות מהירות.
- **Detach Partition**: בעתיד, נוכל לנתק חודשים ישנים מאוד (למשל מלפני שנתיים) ולהעביר אותם לארכיון (ClickHouse) בשניות, במקום למחוק שורות אחת-אחת.
